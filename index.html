<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Map Duck V50 - Minimap Expand</title>
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --panel-bg: rgba(20, 20, 30, 0.95);
            --accent-blue: #3e48d6;
            --accent-green: #228b22;
            --accent-gold: #ffd700;
            --text-main: #ffffff;
        }

        body {
            background-color: var(--bg-dark); color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0; overflow: hidden; height: 100vh; width: 100vw;
            user-select: none; -webkit-user-select: none; touch-action: none;
        }

        /* --- ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ --- */
        #game-container { position: relative; width: 100%; height: 100%; background-color: #000; z-index: 1; }
        canvas { display: block; image-rendering: pixelated; width: 100%; height: 100%; }

        /* --- UIãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ --- */
        #ui-toggle-btn {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: var(--accent-blue); color: white; border: 2px solid white;
            padding: 12px 24px; cursor: pointer; border-radius: 30px; 
            font-weight: bold; font-size: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: flex; align-items: center; gap: 8px; transition: 0.3s;
        }
        #ui-toggle-btn.active { background: #d63e3e; }

        /* --- å³å´ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ --- */
        #ui-layer {
            position: absolute; top: 0; right: 0; z-index: 500;
            width: 320px; height: 100vh; background: var(--panel-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            transform: translateX(0); display: flex; flex-direction: column;
            padding-top: 85px; box-sizing: border-box;
        }
        #ui-layer.hidden { transform: translateX(105%); }

        .ui-scroll-area {
            flex: 1; overflow-y: auto; padding: 0 20px 40px 20px;
            -webkit-overflow-scrolling: touch;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 12px; 
            border: 1px solid rgba(255,255,255,0.1); margin-bottom: 16px;
        }

        h1 { margin: 0 0 12px 0; font-size: 18px; color: var(--accent-gold); border-bottom: 1px solid #444; padding-bottom: 8px; }
        h2 { font-size: 14px; margin: 10px 0 5px; color: #ccc; }

        .btn {
            background: #444; color: white; border: 1px solid #666;
            padding: 12px; cursor: pointer; font-size: 14px; margin-bottom: 8px;
            display: block; width: 100%; box-sizing: border-box; text-align: center; border-radius: 10px;
            font-weight: bold; text-decoration: none;
        }
        .btn:active { transform: scale(0.96); opacity: 0.8; }
        .btn-main { background: var(--accent-blue); border-color: #fff; }
        .btn-success { background: var(--accent-green); border: none; }
        .btn-warn { background: var(--accent-gold); color: #000; border: none; }

        /* --- ãƒŸãƒ‹ãƒãƒƒãƒ— (ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§) --- */
        #minimap-container {
            position: absolute; bottom: 25px; left: 25px; z-index: 100;
            border: 2px solid #fff; background: #000; 
            width: 120px; border-radius: 8px; overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        /* æ‹¡å¤§æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #minimap-container.expanded {
            width: 85vw; height: auto;
            max-height: 80vh;
            bottom: 50%; left: 50%;
            transform: translate(-50%, 50%);
            z-index: 2000; /* UIã‚ˆã‚Šå‰é¢ã«è¡¨ç¤º */
            border: 4px solid var(--accent-gold);
        }
        #minimap { width: 100%; display: block; height: auto; }

        /* ãƒŸãƒ‹ãƒãƒƒãƒ—æ‹¡å¤§ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #minimap-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 1500; display: none;
        }
        #minimap-overlay.show { display: block; }

        /* --- æ“ä½œç”¨ D-Pad --- */
        #d-pad { position: absolute; bottom: 30px; left: 160px; z-index: 100; display: none; }
        .d-grid { display: grid; grid-template-columns: 55px 55px 55px; grid-template-rows: 55px 55px; gap: 5px; }
        .d-btn { 
            background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255,255,255,0.3);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: #fff; backdrop-filter: blur(5px);
        }

        #status-bar { margin-top: 10px; font-size: 12px; color: var(--accent-gold); font-weight: bold; }
        input[type="file"] { display: none; }

        .overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9);
            z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .overlay.show { display: flex; }

        #floor-list { margin-bottom: 10px; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; }
        .floor-item {
            display: flex; justify-content: space-between; padding: 12px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer;
        }
        .floor-item.active { background: var(--accent-blue); }

        .palette { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 10px; }
        .p-item {
            aspect-ratio: 1; border: 2px solid #555; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; background: #222; border-radius: 8px;
        }
        .p-item.selected { border-color: var(--accent-gold); background: #444; }

    </style>
</head>
<body>

    <button id="ui-toggle-btn">âš™ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>

    <input type="file" id="fileInput" accept="image/*">
    <input type="file" id="loadDataInput" accept=".json">

    <div id="ui-layer">
        <div class="ui-scroll-area">
            <div class="panel">
                <h1>ğŸ¢ ãƒ•ãƒ­ã‚¢ãƒ»é–“å–ã‚Š</h1>
                <div id="floor-list"></div>
                <button class="btn btn-main" id="addFloorBtn">ï¼‹ éšã‚’è¿½åŠ </button>
                <button class="btn btn-success" id="selectImageBtn">ğŸ“‚ å›³é¢ã‚’èª­ã¿è¾¼ã‚€</button>
            </div>

            <div class="panel">
                <h1>ğŸ› ï¸ ç·¨é›†ãƒ»ãƒãƒªã‚¢ãƒ•ãƒªãƒ¼</h1>
                <button id="editToggleBtn" class="btn">ğŸ› ï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
                <div id="editor-ui" style="display:none;">
                    <div class="palette">
                        <div class="p-item selected" data-type="wall">ğŸ§±</div>
                        <div class="p-item" data-type="floor">â¬œ</div>
                        <div class="p-item" data-type="elevator">ã‚¨ãƒ¬</div>
                        <div class="p-item" data-type="stairs">éšæ®µ</div>
                        <div class="p-item" data-type="spawn">ğŸ</div>
                        <div class="p-item" data-type="goal">ğŸŒŸ</div>
                        <div class="p-item" data-type="eraser">âŒ</div>
                    </div>
                    <div style="margin-top:10px;">
                        <input type="range" id="sliderBlack" min="0" max="255" value="150" style="width:100%;">
                    </div>
                </div>
            </div>

            <div class="panel">
                <h1>ğŸ¦† MetaMap æ¡ˆå†…</h1>
                <button id="guideBtn" class="btn btn-warn">ğŸ¦† ã‚´ãƒ¼ãƒ«ã¸ã®æ¡ˆå†…ã‚’é–‹å§‹</button>
                <button id="playModeBtn" class="btn btn-success">ğŸ® æ¢ç´¢ã«æˆ»ã‚‹</button>
                <div id="status-bar">æº–å‚™å®Œäº†</div>
            </div>

            <div class="panel">
                <h1>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿</h1>
                <div style="display:flex; gap:5px;">
                    <button class="btn" id="saveBtn" style="flex:1">ğŸ’¾ ä¿å­˜</button>
                    <button class="btn" id="loadBtn" style="flex:1">ğŸ“‚ èª­è¾¼</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒŸãƒ‹ãƒãƒƒãƒ—æ‹¡å¤§ç”¨ã®èƒŒæ™¯èƒŒæ™¯ -->
    <div id="minimap-overlay"></div>
    <div id="minimap-container" title="å…¨ä½“å›³ã‚’è¡¨ç¤º"><canvas id="minimap"></canvas></div>

    <div id="game-container"><canvas id="gameCanvas"></canvas></div>
    
    <div id="d-pad">
        <div class="d-grid">
            <div style="grid-column: 2;"><div class="d-btn" id="btn-up">â–²</div></div>
            <div class="d-btn" id="btn-left">â—€</div>
            <div class="d-btn" id="btn-down">â–¼</div>
            <div class="d-btn" id="btn-right">â–¶</div>
        </div>
    </div>

    <div id="goal-overlay" class="overlay">
        <h2 style="color:var(--accent-gold); font-size:48px;">GOAL!!</h2>
        <button class="btn btn-main" style="width:200px;" onclick="closeGoal()">æ¢ç´¢ã«æˆ»ã‚‹</button>
    </div>

<script>
    const MAP_RES = 800; const TILE_SIZE = 8; const MOVE_SPEED = 0.8;
    const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');
    const miniContainer = document.getElementById('minimap-container');
    const miniOverlay = document.getElementById('minimap-overlay');
    const uiLayer = document.getElementById('ui-layer'); const uiToggleBtn = document.getElementById('ui-toggle-btn');
    const statusDiv = document.getElementById('status-bar');

    let floors = []; let curFloorIdx = 0;
    let player = { x: 0, y: 0 }; let camera = { x: 0, y: 0 };
    let isEditing = false; let currentTool = 'wall';
    let guideNPC = { x:0, y:0, active: false, path: [] };
    const keys = { Up: false, Down: false, Left: false, Right: false };

    class Floor {
        constructor(name) {
            this.name = name; this.image = null; this.imageSrc = null;
            this.cols = 0; this.rows = 0; this.grid = []; this.objs = [];
            this.spawn = null; this.goal = null; this.ready = false;
            this.canvas = document.createElement('canvas');
        }
    }

    function init() {
        window.addEventListener('resize', resize); resize();
        
        // ãƒŸãƒ‹ãƒãƒƒãƒ—æ‹¡å¤§ãƒˆã‚°ãƒ«
        miniContainer.onclick = () => {
            const isExpanded = miniContainer.classList.toggle('expanded');
            if(isExpanded) miniOverlay.classList.add('show');
            else miniOverlay.classList.remove('show');
        };

        // èƒŒæ™¯ã‚¿ãƒƒãƒ—ã§ã‚‚ãƒŸãƒ‹ãƒãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
        miniOverlay.onclick = () => {
            miniContainer.classList.remove('expanded');
            miniOverlay.classList.remove('show');
        };

        uiToggleBtn.onclick = () => {
            uiLayer.classList.toggle('hidden');
            uiToggleBtn.classList.toggle('active');
            uiToggleBtn.innerText = uiLayer.classList.contains('hidden') ? "âš™ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼" : "âŒ é–‰ã˜ã‚‹";
        };

        document.getElementById('selectImageBtn').onclick = () => document.getElementById('fileInput').click();
        document.getElementById('fileInput').onchange = handleImageSelect;
        document.getElementById('addFloorBtn').onclick = () => addFloor(prompt("éšã®åå‰"));
        document.getElementById('editToggleBtn').onclick = toggleEditMode;
        document.getElementById('playModeBtn').onclick = () => { uiLayer.classList.add('hidden'); uiToggleBtn.classList.remove('active'); };
        document.getElementById('saveBtn').onclick = saveToJSON;
        document.getElementById('loadBtn').onclick = () => document.getElementById('loadDataInput').click();
        document.getElementById('loadDataInput').onchange = loadFromJSON;
        document.getElementById('guideBtn').onclick = startGuiding;

        document.querySelectorAll('.p-item').forEach(i => i.onclick = () => {
            document.querySelectorAll('.p-item').forEach(x => x.classList.remove('selected'));
            i.classList.add('selected'); currentTool = i.dataset.type;
        });

        if ('ontouchstart' in window) { document.getElementById('d-pad').style.display = 'block'; setupMobileControls(); }

        addFloor("1F");
        requestAnimationFrame(loop);
    }

    function handleImageSelect(e) {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            const img = new Image();
            img.onload = () => {
                const f = getCurFloor();
                f.image = img; f.imageSrc = evt.target.result;
                f.cols = Math.min(MAP_RES, img.width);
                f.rows = Math.floor(f.cols * (img.height / img.width));
                f.canvas.width = f.cols * TILE_SIZE; f.canvas.height = f.rows * TILE_SIZE;
                f.grid = Array(f.rows).fill().map(() => Array(f.cols).fill(0));
                analyzeFloor(f);
                f.ready = true;
                player.x = f.cols / 2; player.y = f.rows / 2;
                updateFloorList();
            };
            img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
    }

    function analyzeFloor(f) {
        const tc = document.createElement('canvas'); tc.width = f.cols; tc.height = f.rows;
        const tx = tc.getContext('2d'); tx.drawImage(f.image, 0, 0, f.cols, f.rows);
        const data = tx.getImageData(0, 0, f.cols, f.rows).data;
        const threshold = document.getElementById('sliderBlack').value;
        for(let y=0; y<f.rows; y++) {
            for(let x=0; x<f.cols; x++) {
                const i = (y * f.cols + x) * 4;
                if((data[i] + data[i+1] + data[i+2])/3 < threshold) f.grid[y][x] = 1;
            }
        }
        renderFloorCanvas(f);
    }

    function renderFloorCanvas(f) {
        const c = f.canvas.getContext('2d');
        c.clearRect(0, 0, f.canvas.width, f.canvas.height);
        if(f.image) c.drawImage(f.image, 0, 0, f.canvas.width, f.canvas.height);
        if(isEditing) {
            c.fillStyle = "rgba(255, 0, 0, 0.3)";
            for(let y=0; y<f.rows; y++) for(let x=0; x<f.cols; x++) if(f.grid[y][x]===1) c.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
        }
    }

    function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    }

    function update() {
        const f = getCurFloor(); if(!f || !f.ready) return;
        let mx = 0, my = 0;
        if(keys.Up) my -= MOVE_SPEED; if(keys.Down) my += MOVE_SPEED;
        if(keys.Left) mx -= MOVE_SPEED; if(keys.Right) mx += MOVE_SPEED;
        if(!checkWall(f, player.x + mx, player.y)) player.x += mx;
        if(!checkWall(f, player.x, player.y + my)) player.y += my;

        if(guideNPC.active && guideNPC.path.length > 0) {
            const t = guideNPC.path[0];
            const dx = t.x - guideNPC.x, dy = t.y - guideNPC.y;
            const dist = Math.hypot(dx, dy);
            if(dist < 1) guideNPC.path.shift();
            else { guideNPC.x += dx/dist*0.5; guideNPC.y += dy/dist*0.5; }
        }

        camera.x += (canvas.width/2 - player.x*TILE_SIZE - camera.x) * 0.1;
        camera.y += (canvas.height/2 - player.y*TILE_SIZE - camera.y) * 0.1;

        if(f.goal && Math.hypot(player.x - f.goal.x, player.y - f.goal.y) < 2) {
            document.getElementById('goal-overlay').classList.add('show');
            f.goal = null;
        }
    }

    function checkWall(f, x, y) {
        if(x < 0 || x >= f.cols || y < 0 || y >= f.rows) return true;
        if(f.objs.some(o => Math.hypot(o.x - x, o.y - y) < 1.5)) return false;
        return f.grid[Math.floor(y)][Math.floor(x)] === 1;
    }

    function draw() {
        ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        const f = getCurFloor(); if(!f || !f.ready) return;

        ctx.save(); ctx.translate(camera.x, camera.y);
        ctx.drawImage(f.canvas, 0, 0);
        f.objs.forEach(o => {
            ctx.fillStyle = o.type === 'elevator' ? "#00f" : "#0f0";
            ctx.fillRect(o.x*TILE_SIZE-10, o.y*TILE_SIZE-10, 20, 20);
        });
        if(f.goal) { ctx.font="30px serif"; ctx.fillText("ğŸŒŸ", f.goal.x*TILE_SIZE-15, f.goal.y*TILE_SIZE+10); }
        if(guideNPC.active) { ctx.font = "24px serif"; ctx.fillText("ğŸ¦†", guideNPC.x*TILE_SIZE-12, guideNPC.y*TILE_SIZE+12); }
        ctx.fillStyle = "#ff0"; ctx.beginPath(); ctx.arc(player.x*TILE_SIZE, player.y*TILE_SIZE, 10, 0, Math.PI*2); ctx.fill();
        ctx.restore();

        // ãƒŸãƒ‹ãƒãƒƒãƒ—æç”»
        const mCtx = document.getElementById('minimap').getContext('2d');
        document.getElementById('minimap').width = f.cols; document.getElementById('minimap').height = f.rows;
        mCtx.drawImage(f.canvas, 0, 0, f.cols, f.rows);
        mCtx.fillStyle = "red"; mCtx.fillRect(player.x-2, player.y-2, 4, 4);
        if(f.goal) { mCtx.fillStyle = "gold"; mCtx.fillText("ğŸŒŸ", f.goal.x-5, f.goal.y+5); }
    }

    function toggleEditMode() {
        isEditing = !isEditing;
        document.getElementById('editor-ui').style.display = isEditing ? "block" : "none";
        const f = getCurFloor(); if(f) renderFloorCanvas(f);
    }

    function addFloor(name) { if(!name) return; floors.push(new Floor(name)); curFloorIdx = floors.length - 1; updateFloorList(); }
    function getCurFloor() { return floors[curFloorIdx]; }
    function updateFloorList() {
        const list = document.getElementById('floor-list'); list.innerHTML = "";
        floors.forEach((f, i) => {
            const div = document.createElement('div'); div.className = "floor-item" + (i === curFloorIdx ? " active" : "");
            div.innerHTML = `<span>${f.name}</span><span>${f.ready ? "âœ…" : "ğŸ“„"}</span>`;
            div.onclick = () => { curFloorIdx = i; updateFloorList(); };
            list.appendChild(div);
        });
    }

    function startGuiding() {
        const f = getCurFloor(); if(!f.goal) return;
        let open = [{x: Math.round(player.x), y: Math.round(player.y)}];
        let cameFrom = new Map(); let visited = new Set();
        let found = null;
        for(let i=0; i<3000 && open.length>0; i++){
            let curr = open.shift();
            if(Math.hypot(curr.x-f.goal.x, curr.y-f.goal.y)<2){ found=curr; break; }
            [[0,1],[0,-1],[1,0],[-1,0]].forEach(d => {
                let nx=curr.x+d[0]*2, ny=curr.y+d[1]*2;
                if(nx>=0 && nx<f.cols && ny>=0 && ny<f.rows && f.grid[ny][nx]!==1 && !visited.has(nx+","+ny)){
                    visited.add(nx+","+ny); let node={x:nx, y:ny}; open.push(node); cameFrom.set(nx+","+ny, curr);
                }
            });
        }
        if(found){
            let path = []; let c = found; while(c){ path.push(c); c = cameFrom.get(c.x+","+c.y); }
            guideNPC = { x: player.x, y: player.y, active: true, path: path.reverse() };
        }
    }

    function saveToJSON() {
        const data = { floors: floors.map(f => ({ name: f.name, grid: f.grid, objs: f.objs, imageSrc: f.imageSrc, spawn: f.spawn, goal: f.goal })), curFloorIdx };
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type: 'application/json'})); a.download = "map_duck.json"; a.click();
    }
    function loadFromJSON(e) {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            const data = JSON.parse(evt.target.result); floors = [];
            data.floors.forEach(fd => {
                const f = new Floor(fd.name); Object.assign(f, fd);
                if(f.imageSrc) {
                    const img = new Image(); img.onload = () => { f.image = img; f.ready = true; renderFloorCanvas(f); }; img.src = f.imageSrc;
                }
                floors.push(f);
            });
            curFloorIdx = data.curFloorIdx; updateFloorList();
        };
        reader.readAsText(file);
    }

    function closeGoal() { document.getElementById('goal-overlay').classList.remove('show'); }
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    function setupMobileControls() {
        const b = (id, k) => {
            const el = document.getElementById(id);
            el.ontouchstart = (e) => { e.preventDefault(); keys[k] = true; };
            el.ontouchend = (e) => { e.preventDefault(); keys[k] = false; };
        };
        b('btn-up','Up'); b('btn-down','Down'); b('btn-left','Left'); b('btn-right','Right');
    }
    window.onkeydown = e => { if(e.code.includes('Arrow')) keys[e.code.replace('Arrow','')] = true; };
    window.onkeyup = e => { if(e.code.includes('Arrow')) keys[e.code.replace('Arrow','')] = false; };

    init();
</script>
</body>
</html>
