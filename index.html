--- START OF FILE Paste January 20, 2026 - 2:49PM ---

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Map Duck V55 - UI Optimized</title>
    <style>
        body {
            background-color: #050505; color: #fff; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            text-align: center; margin: 0; padding: 0;
            overflow: hidden; height: 100vh; width: 100vw;
            user-select: none; -webkit-user-select: none;
            touch-action: none;
        }

        /* --- UIãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ (å³ä¸Š) --- */
        #ui-toggle-btn {
            position: absolute; top: 15px; right: 15px; z-index: 1000;
            background: #3e48d6; color: #fff; border: 2px solid #fff;
            padding: 12px 20px; cursor: pointer; border-radius: 30px; 
            font-weight: bold; font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            display: flex; align-items: center; gap: 8px;
        }
        #ui-toggle-btn.active {
            background: #d63e3e;
            transform: scale(1.05);
        }

        /* --- UIãƒ‘ãƒãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ (å³å´ã‚¹ãƒ©ã‚¤ãƒ‰å¼) --- */
        #ui-layer {
            position: absolute; top: 0; right: 0; z-index: 500;
            width: 300px; height: 100vh;
            background: rgba(15, 15, 25, 0.95);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-left: 1px solid rgba(255,255,255,0.2);
            box-shadow: -5px 0 25px rgba(0,0,0,0.8);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            transform: translateX(0); /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º */
            display: flex; flex-direction: column;
            padding-top: 80px; /* ãƒœã‚¿ãƒ³ã‚’é¿ã‘ã‚‹ */
            box-sizing: border-box;
        }
        
        /* éš ã™ã¨ãã¯å³ã¸å®Œå…¨ã«éš ã™ */
        #ui-layer.hidden { transform: translateX(105%); }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
        .ui-scroll-container {
            flex: 1; overflow-y: auto; padding: 0 20px 40px 20px;
            -webkit-overflow-scrolling: touch;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 12px; 
            border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px;
        }

        h1 { margin: 0 0 12px 0; font-size: 16px; color: #ffd700; border-bottom: 1px solid #444; padding-bottom: 5px; text-align: left; }
        
        .btn {
            background: #444; color: white; border: 1px solid #666;
            padding: 12px; cursor: pointer; font-size: 14px; margin-bottom: 8px;
            display: block; width: 100%; box-sizing: border-box; text-align: center; border-radius: 10px;
            font-weight: 500;
        }
        .btn:active { transform: scale(0.97); background: #555; }
        .btn-blue { background: #3e48d6; border-color: #5c67ff; }
        .btn-green { background: #228b22; border-color: #32cd32; }
        .btn-yellow { background: #daa520; color: #000; font-weight: bold; border-color: #fff; }
        .btn-red { background: #8b0000; border-color: #f55; }
        .btn-cyan { background: #008b8b; color:#fff;}
        .btn-purple { background: #6a1b9a; border-color: #9c27b0; }
        .btn-toggle.active { background: #d63e3e; border: 1px solid #f55; }

        #floor-list {
            margin-bottom: 10px; max-height: 150px; overflow-y: auto;
            background: rgba(0,0,0,0.2); border-radius: 8px; padding: 5px;
        }
        .floor-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; margin-bottom: 5px; cursor: pointer; border-radius: 6px;
            border: 1px solid transparent; font-size: 14px;
        }
        .floor-item.active { background: #3e48d6; border-color: #fff; }

        input[type="file"] { display: none; }
        .slider-row { margin-bottom: 15px; font-size: 12px; text-align: left; }
        input[type=range] { width: 100%; height: 30px; }

        #game-container { position: relative; width: 100%; height: 100%; background-color: #111; z-index: 10; }
        canvas { display: block; image-rendering: pixelated; width: 100%; height: 100%; object-fit: contain; }

        /* ãƒŸãƒ‹ãƒãƒƒãƒ— (å·¦ä¸‹ã¸ç§»å‹•ã—ã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«) */
        #minimap-container {
            position: absolute; bottom: 20px; left: 20px; z-index: 100;
            border: 2px solid #fff; background: #000;
            width: 120px; border-radius: 8px; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        #minimap { width: 100%; display: block; height: auto; }

        /* ã‚¨ãƒ‡ã‚£ã‚¿UIã®ãƒ‘ãƒ¬ãƒƒãƒˆ */
        #editor-ui { border-top: 1px dashed #555; margin-top: 15px; padding-top: 15px; display: none; }
        .palette { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .p-item {
            aspect-ratio: 1; border: 1px solid #555; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; background: #222; border-radius: 8px;
        }
        .p-item.selected { border: 2px solid #ffd700; background: #444; }
        
        #status { margin-top:10px; font-size:12px; color:#ffcc00; font-weight: bold; }
        
        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ (å·¦å´ã«å¯„ã›ã‚‹) */
        #d-pad { 
            position: absolute; bottom: 40px; left: 160px; /* ãƒŸãƒ‹ãƒãƒƒãƒ—ã®æ¨ª */
            z-index: 100; display: none; width: 180px;
        }
        .d-row { display: flex; justify-content: center; }
        .d-btn { 
            width: 50px; height: 50px; background: rgba(255, 255, 255, 0.2); 
            border: 1px solid rgba(255,255,255,0.4); margin: 4px; border-radius: 12px; 
            line-height: 50px; font-size: 24px; color: #fff; backdrop-filter: blur(4px);
        }

        /* ã‚´ãƒ¼ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #overlay.show { display: flex; }
    </style>
</head>
<body>

    <!-- æ“ä½œã®è¦ï¼šãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
    <button id="ui-toggle-btn"><span>âš™ï¸</span> <span>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span></button>

    <input type="file" id="fileInput" accept="image/*">
    <input type="file" id="heroInput" accept="image/*">
    <input type="file" id="loadDataInput" accept=".json">

    <div id="ui-layer">
        <div class="ui-scroll-container">
            <div class="panel">
                <h1>ğŸ—ºï¸ ãƒ•ãƒ­ã‚¢ç®¡ç†</h1>
                <div id="floor-list"></div>
                <button class="btn btn-blue" id="addFloorBtn">ï¼‹ æ–°ã—ã„éšã‚’è¿½åŠ </button>
                <button class="btn btn-green" id="selectImageBtn">ğŸ“‚ ç”»åƒã‚’èª­ã¿è¾¼ã‚€</button>
            </div>

            <div class="panel">
                <h1>ğŸ› ï¸ ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</h1>
                <button id="editToggleBtn" class="btn btn-toggle">ğŸ› ï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
                <button id="playModeBtn" class="btn btn-green">ğŸ® ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰ (UIéš ã™)</button>
                <button id="viewToggleBtn" class="btn">ğŸ‘ï¸ è¡¨ç¤ºåˆ‡æ›¿ (ç”»åƒ/RPG)</button>
                
                <div id="editor-ui">
                    <div class="palette">
                        <div class="p-item" data-type="select" title="è¨­å®š">âœ‹</div>
                        <div class="p-item" data-type="stairs_up" title="éšæ®µ">ğŸ“¶</div>
                        <div class="p-item" data-type="goal" title="ã‚´ãƒ¼ãƒ«">ğŸŒŸ</div>
                        <div class="p-item" data-type="spawn" title="ã‚¹ã‚¿ãƒ¼ãƒˆ">ğŸ</div>
                        <div class="p-item selected" data-type="wall" title="å£">ğŸ§±</div>
                        <div class="p-item" data-type="floor" title="åºŠ">â¬œ</div>
                        <div class="p-item" data-type="concrete" title="å¤–">ğŸ›£ï¸</div>
                        <div class="p-item" data-type="eraser" title="å‰Šé™¤">âŒ</div>
                    </div>
                    <div class="slider-group" style="margin-top:15px;">
                        <div class="slider-row">è§£ææ„Ÿåº¦: <input type="range" id="sliderBlack" min="0" max="255" value="150"></div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h1>ğŸ“± æ©Ÿèƒ½ãƒ»ä¿å­˜</h1>
                <button id="guideBtn" class="btn btn-yellow">ğŸ¦† ã‚´ãƒ¼ãƒ«ã¸ã®ã‚¬ã‚¤ãƒ‰</button>
                <button id="nfcReadBtn" class="btn btn-purple">ğŸ“¡ NFCèª­å–</button>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-cyan" id="saveDataBtn" style="flex:1">ğŸ’¾ ä¿å­˜</button>
                    <button class="btn btn-cyan" id="loadDataBtn" style="flex:1">ğŸ“‚ èª­è¾¼</button>
                </div>
                <div id="status">æº–å‚™å®Œäº†</div>
                <button class="btn btn-red" id="resetBtn" style="margin-top:20px;">âš ï¸ åˆæœŸåŒ–</button>
            </div>
        </div>
    </div>

    <div id="minimap-container"><canvas id="minimap"></canvas></div>
    <div id="game-container"><canvas id="gameCanvas"></canvas></div>
    
    <div id="d-pad">
        <div class="d-row"><div class="d-btn" id="btn-up">â–²</div></div>
        <div class="d-row"><div class="d-btn" id="btn-left">â—€</div><div class="d-btn" id="btn-down">â–¼</div><div class="d-btn" id="btn-right">â–¶</div></div>
    </div>

    <!-- ã‚´ãƒ¼ãƒ«è¡¨ç¤ºãªã©ã¯å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶­æŒ -->
    <div id="overlay">
        <h2 style="color:gold; font-size:40px;">GOAL!!</h2>
        <canvas id="material-preview" width="300" height="300" style="border:2px solid #fff;"></canvas>
        <button class="btn btn-blue" id="close-overlay" style="width:200px; margin-top:20px;">é–‰ã˜ã‚‹</button>
    </div>

<script>
    // åŸºæœ¬è¨­å®š
    const MAP_RES = 600; TILE_SIZE = 8; MOVE_SPEED = 0.8; GUIDE_SPEED = 0.4;

    const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');
    const uiToggleBtn = document.getElementById('ui-toggle-btn');
    const uiLayer = document.getElementById('ui-layer');
    const statusDiv = document.getElementById('status');
    const overlay = document.getElementById('overlay');

    let floors = []; let curFloorIdx = 0;
    let player = { x: 0, y: 0 }; let camera = { x: 0, y: 0 };
    let isEditing = false; let currentTool = 'wall';
    let heroImage = null; let facingRight = true;
    const keys = { Up: false, Down: false, Left: false, Right: false };

    class Floor {
        constructor(name) {
            this.name = name; this.imageSrc = null; this.image = null;
            this.cols = 0; this.rows = 0; this.grid = []; this.objs = [];
            this.canvas = document.createElement('canvas'); this.ready = false; 
        }
    }

    function init() {
        window.addEventListener('resize', resize); resize();
        
        // --- UIãƒˆã‚°ãƒ«å‡¦ç†ã®æ”¹å–„ ---
        uiToggleBtn.addEventListener('click', () => {
            const isHidden = uiLayer.classList.contains('hidden');
            if(isHidden) {
                uiLayer.classList.remove('hidden');
                uiToggleBtn.classList.add('active');
                uiToggleBtn.innerHTML = "<span>âŒ</span> <span>é–‰ã˜ã‚‹</span>";
            } else {
                uiLayer.classList.add('hidden');
                uiToggleBtn.classList.remove('active');
                uiToggleBtn.innerHTML = "<span>âš™ï¸</span> <span>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>";
            }
        });

        if ('ontouchstart' in window) {
            document.getElementById('d-pad').style.display = 'block';
            setupTouchControls();
        }

        addFloor("1éš");
        requestAnimationFrame(loop);
    }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

    // ãƒœã‚¿ãƒ³ã¨Input
    document.getElementById('selectImageBtn').onclick = () => document.getElementById('fileInput').click();
    document.getElementById('addFloorBtn').onclick = () => addFloor(prompt("éšã®åå‰ã‚’å…¥åŠ›"));
    
    // ç”»åƒèª­ã¿è¾¼ã¿
    document.getElementById('fileInput').onchange = (e) => {
        const file = e.target.files[0]; if(!file) return;
        const f = getCurFloor();
        const reader = new FileReader();
        reader.onload = (evt) => {
            const img = new Image();
            img.onload = () => {
                f.image = img; f.imageSrc = evt.target.result;
                f.cols = Math.min(MAP_RES, img.width); f.rows = Math.floor(f.cols * (img.height / img.width));
                f.canvas.width = f.cols*TILE_SIZE; f.canvas.height = f.rows*TILE_SIZE;
                f.grid = Array(f.rows).fill().map(()=>Array(f.cols).fill(0));
                autoAnalyze(f);
                f.ready = true;
                player.x = f.cols/2; player.y = f.rows/2;
                updateFloorList();
                statusDiv.innerText = "èª­è¾¼å®Œäº†";
            };
            img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
    };

    function autoAnalyze(f) {
        const tc = document.createElement('canvas'); tc.width=f.cols; tc.height=f.rows;
        const tctx=tc.getContext('2d'); tctx.drawImage(f.image,0,0,f.cols,f.rows);
        const data=tctx.getImageData(0,0,f.cols,f.rows).data;
        const pBlack = document.getElementById('sliderBlack').value;
        for(let y=0; y<f.rows; y++) for(let x=0; x<f.cols; x++) {
            const i=(y*f.cols+x)*4; if((data[i]+data[i+1]+data[i+2])/3 < pBlack) f.grid[y][x]=1;
        }
        redrawFloor(f);
    }

    function redrawFloor(f) {
        const c = f.canvas.getContext('2d');
        c.fillStyle="#111"; c.fillRect(0,0,f.canvas.width,f.canvas.height);
        if(f.image) c.drawImage(f.image, 0, 0, f.canvas.width, f.canvas.height);
        for(let y=0; y<f.rows; y++) for(let x=0; x<f.cols; x++) {
            if(f.grid[y][x]===1) { c.fillStyle="rgba(255, 0, 0, 0.4)"; c.fillRect(x*TILE_SIZE,y*TILE_SIZE,TILE_SIZE,TILE_SIZE); }
        }
    }

    function addFloor(name) {
        const f = new Floor(name || (floors.length+1)+"éš"); floors.push(f);
        changeFloor(floors.length - 1);
    }

    function changeFloor(idx) {
        curFloorIdx = idx; updateFloorList();
    }

    function getCurFloor() { return floors[curFloorIdx]; }

    function updateFloorList() {
        const list = document.getElementById('floor-list'); list.innerHTML = "";
        floors.forEach((f, i) => {
            const div = document.createElement('div');
            div.className = "floor-item" + (i === curFloorIdx ? " active" : "");
            div.innerHTML = `<span>${f.name}</span><span>${f.ready?"âœ…":""}</span>`;
            div.onclick = () => changeFloor(i); list.appendChild(div);
        });
    }

    function loop() { update(); draw(); requestAnimationFrame(loop); }

    function update() {
        const f = getCurFloor(); if(!f || !f.ready) return;
        let mx=0, my=0;
        if(keys.Up) my-=MOVE_SPEED; if(keys.Down) my+=MOVE_SPEED;
        if(keys.Left) { mx-=MOVE_SPEED; facingRight=false; } if(keys.Right) { mx+=MOVE_SPEED; facingRight=true; }
        
        if(mx!==0 || my!==0) {
            const nx = player.x + mx, ny = player.y + my;
            if(!checkHit(f, nx, player.y)) player.x=nx;
            if(!checkHit(f, player.x, ny)) player.y=ny;
        }
        camera.x += (canvas.width/2 - player.x*TILE_SIZE - camera.x) * 0.1;
        camera.y += (canvas.height/2 - player.y*TILE_SIZE - camera.y) * 0.1;
    }

    function checkHit(f, x, y) {
        if(x<0||x>=f.cols||y<0||y>=f.rows) return true;
        return f.grid[Math.floor(y)][Math.floor(x)] === 1;
    }

    function draw() {
        ctx.fillStyle="#111"; ctx.fillRect(0,0,canvas.width,canvas.height);
        const f = getCurFloor(); if(!f || !f.ready) return;
        ctx.save(); ctx.translate(camera.x, camera.y);
        ctx.drawImage(f.canvas, 0, 0);
        // Player
        ctx.fillStyle = "yellow";
        ctx.fillRect(player.x*TILE_SIZE-10, player.y*TILE_SIZE-20, 20, 20);
        ctx.restore();
        
        // Minimap
        const mCtx = document.getElementById('minimap').getContext('2d');
        document.getElementById('minimap').width = f.cols;
        document.getElementById('minimap').height = f.rows;
        mCtx.drawImage(f.canvas, 0, 0, f.cols, f.rows);
        mCtx.fillStyle="red"; mCtx.fillRect(player.x-2, player.y-2, 4, 4);
    }

    function setupTouchControls() {
        const bind = (id, k) => { 
            const b=document.getElementById(id); 
            b.ontouchstart=e=>{e.preventDefault();keys[k]=true}; 
            b.ontouchend=e=>{e.preventDefault();keys[k]=false}; 
        };
        bind('btn-up','Up'); bind('btn-down','Down'); bind('btn-left','Left'); bind('btn-right','Right');
    }

    document.getElementById('editToggleBtn').onclick = (e) => {
        isEditing = !isEditing;
        document.getElementById('editor-ui').style.display = isEditing ? "block" : "none";
        e.target.innerText = isEditing ? "ğŸ› ï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çµ‚äº†" : "ğŸ› ï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹";
        e.target.classList.toggle('active');
    };

    document.getElementById('playModeBtn').onclick = () => {
        uiLayer.classList.add('hidden');
        uiToggleBtn.classList.remove('active');
        uiToggleBtn.innerHTML = "<span>âš™ï¸</span> <span>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>";
    };

    window.onkeydown = e => { if(e.code.includes('Arrow')) keys[e.code.replace('Arrow','')] = true; };
    window.onkeyup = e => { if(e.code.includes('Arrow')) keys[e.code.replace('Arrow','')] = false; };

    init();
</script>
</body>
</html>
